import EacReadTheFeed from"../modules/eac-ajax-read-feed.js";class widgetRssReader extends elementorModules.frontend.handlers.Base{getDefaultSettings(){return{selectors:{targetInstance:".eac-rss-galerie",targetSelect:".select__options-items",targetButton:"#rss__read-button",targetHeader:".rss-item__header",targetLoader:"#rss__loader-wheel",targetNonce:"#rss_nonce",target:".rss-galerie"}}}getDefaultElements(){const e=this.getSettings("selectors");return{$targetInstance:this.$element.find(e.targetInstance),$targetSelect:this.$element.find(e.targetSelect),$targetButton:this.$element.find(e.targetButton),$targetHeader:this.$element.find(e.targetHeader),$targetLoader:this.$element.find(e.targetLoader),$target:this.$element.find(e.target),targetNonce:this.$element.find(e.targetNonce).val(),settings:this.$element.find(e.target).data("settings")||{},instanceAjax:null,is_ios:/(Macintosh|iPhone|iPod|iPad).*AppleWebKit.*Safari/i.test(navigator.userAgent)}}onInit(){super.onInit(),this.elements.$targetSelect.find("option:first").attr("selected","selected")}bindEvents(){Object.keys(this.elements.settings).length>0&&(this.elements.$targetSelect.on("change",this.onSelectChange.bind(this)),this.elements.$targetButton.on("click touch",this.onTriggerButton.bind(this)),this.elements.$targetInstance.on("keydown",this.onTriggerKeyboard.bind(this)),jQuery(document).on("ajaxComplete",this.ajaxQueryComplete.bind(this)))}onSelectChange(e){e.preventDefault(),this.elements.$targetLoader.hide(),this.elements.$target.attr("aria-busy","false"),this.elements.$targetButton.attr("aria-expanded","false"),this.elements.$target.empty(),this.elements.$targetHeader.html("")}onTriggerButton(e){e.preventDefault(),this.elements.$targetButton.attr("aria-expanded","true"),this.elements.$target.empty(),this.elements.$targetHeader.html(""),this.elements.instanceAjax=new EacReadTheFeed(jQuery(".select__options-items option:selected",this.elements.$targetInstance).val().replace(/\s+/g,""),this.elements.targetNonce,this.elements.settings.data_id),this.elements.$targetLoader.show(),this.elements.$target.attr("aria-busy","true")}onTriggerKeyboard(e){const t=e.code||e.key||0;if(!this.elements.$target.is(":empty"))if("Escape"===t)e.preventDefault(),this.elements.$targetButton.attr("aria-expanded","false"),this.elements.$target.empty(),this.elements.$targetHeader.html(""),this.elements.$targetSelect.trigger("focus");else if("End"===t){e.preventDefault();this.elements.$target.find("article").find("a").last().trigger("focus")}else if("Home"===t){e.preventDefault();this.elements.$target.find("article").find("a").first().trigger("focus")}}ajaxQueryComplete(e,t,a){if(null!==this.elements.instanceAjax&&a.ajaxOptions&&a.ajaxOptions===this.elements.instanceAjax.getOptions()){e.stopImmediatePropagation(),this.elements.$targetLoader.hide(),this.elements.$target.attr("aria-busy","false");const t=this.elements.instanceAjax.getItems();if(t.headError)return this.elements.$targetHeader.html('<span style="text-align:center; word-break:break-word;"><p>'+t.headError+"</p></span>"),!1;if(!t.rss)return this.elements.$targetHeader.html('<span style="text-align: center">Nothing to display</span>'),!1;const a=t.rss,s=t.profile,i=jQuery("<div/>",{class:"rss-item__header-content"});s.headLogo&&this.elements.$targetHeader.append('<div class="rss-item__header-img"><a href="'+s.headLink+'" aria-label="View RSS feed provider '+s.headTitle+'"><img class="eac-image-loaded" src="'+s.headLogo+'" alt="'+s.headTitle+'"></a></div>'),i.append('<span><a href="'+s.headLink+'" aria-label="View RSS feed provider '+s.headTitle+'"><h2>'+s.headTitle.substring(0,27)+"...</h2></a></span>"),i.append("<span>"+s.headDescription+"</span>"),this.elements.$targetHeader.append(i),jQuery.each(a,((e,t)=>{if(e>=this.elements.settings.data_nombre)return!1;const a=jQuery("<article/>",{class:"rss-galerie__item"}),s=jQuery("<div/>",{class:"rss-galerie__content"}),i=jQuery("<div/>",{class:"rss-galerie__content-inner"});if(t.img&&this.elements.settings.data_img){let e="",a="";const i=jQuery.trim(t.title.replace(/"/g," "));t.img.match(/\.mp3|\.m4a/)?e='<div class="rss-galerie__item-image"><audio aria-label="Listen feed '+i+'" controls preload="none" src="'+t.img+'" type="audio/mp3"></audio></div>':t.img.match(/\.mp4|\.m4v/)?(a=is_ios?'<video aria-label="View feed video '+i+'" controls preload="metadata" type="video/mp4">':'<video controls preload="none" type="video/mp4">',e='<div class="rss-galerie__item-image">'+a+'<source src="'+t.img+"\">Your browser doesn't support embedded videos</video></div>"):e=t.img.match(/\.pdf/)?'<div class="rss-galerie__item-image" aria-label="View PDF file '+i+'"><a href="'+t.imgLink+'" data-elementor-open-lightbox="no" data-fancybox="rss-gallery" data-caption="'+i+'"><i class="far fa-file-pdf" aria-hidden="true"></i></a></div>':this.elements.settings.data_lightbox?'<div class="rss-galerie__item-image"><a href="'+t.imgLink+'" class="eac-accessible-link" aria-label="View feed image '+i+'" data-elementor-open-lightbox="no" data-fancybox="rss-gallery" data-caption="'+i+'"><img class="img-focusable eac-image-loaded" src="'+t.img+'"></a></div>':this.elements.settings.data_image_link?'<div class="rss-galerie__item-image"><a href="'+t.lien+'" class="eac-accessible-link" aria-label="View feed '+i+'"><img class="img-focusable eac-image-loaded" src="'+t.img+'"></a></div>':'<div class="rss-galerie__item-image"><img class="eac-image-loaded" src="'+t.img+'"></div>',s.append(e)}if(this.elements.settings.data_title){t.title=t.title.split(" ",12).join().replace(/,/g," ")+"...";let e="";e=this.elements.settings.data_title_link?'<div class="rss-galerie__item-link-post"><a href="'+t.lien+'" class="eac-accessible-link" aria-label="View feed '+t.title+'"><h2 class="rss-galerie__item-titre">'+t.title+"</h2></a></div>":'<div class="rss-galerie__item-link-post"><h2 class="rss-galerie__item-titre">'+t.title+"</h2></div>",i.append(e)}if(this.elements.settings.data_excerpt){t.description=removeEmojis(t.description),t.description=t.description.split(" ",this.elements.settings.data_excerpt_lenght).join().replace(/,/g," ")+"[...]";const e='<div class="rss-galerie__item-description"><p>'+t.description+"</p></div>";i.append(e)}if(this.elements.settings.data_readmore){let e=this.elements.settings.data_readmore_label,a="";this.elements.settings.data_icon&&(a='<i class="'+this.elements.settings.data_icon+'" aria-hidden="true"></i>',"before"===this.elements.settings.data_icon_pos?e=a+e:e+=a);const s='<div class="buttons-wrapper"><span class="button__readmore-wrapper"><a href="'+t.lien+'" class="button-readmore" aria-label="View feed '+t.title+'">'+e+"</a></span></div>";i.append(s)}if(this.elements.settings.data_date){let e=jQuery("<div/>",{class:"rss-galerie__item-metas"});const a='<span class="rss-galerie__item-date"><i class="fas fa-calendar" aria-hidden="true"></i>'+new Date(t.update).toLocaleDateString()+"</span>",s='<span class="rss-galerie__item-auteur"><i class="fas fa-user" aria-hidden="true"></i>'+t.author+"</span>";e.append(a),t.author&&e.append(s),i.append(e)}s.append(i),a.append(s),this.elements.$target.append(a)})),setTimeout((()=>{jQuery(".rss-galerie__item",this.elements.$target).css({transition:"all 500ms linear",transform:"scale(1)"})}),200)}}}jQuery(window).on("elementor/frontend/init",(()=>{elementorFrontend.elementsHandler.attachHandler("eac-addon-lecteur-rss",widgetRssReader)}));