class widgetOpenStreetMap extends elementorModules.frontend.handlers.Base{getDefaultSettings(){return{selectors:{targetInstance:".eac-open-streetmap",targetWrapper:".osm-map_wrapper",targetMarkerCenter:".osm-map_wrapper-markercenter",targetMarkers:".osm-map_wrapper-marker"}}}getDefaultElements(){const e=this.getSettings("selectors");return{$targetInstance:this.$element.find(e.targetInstance),$targetWrapper:this.$element.find(e.targetWrapper),$targetMarkerCenter:this.$element.find(e.targetMarkerCenter),$targetMarkers:this.$element.find(e.targetMarkers),targetNonce:this.$element.find(e.targetInstance).find("#osm_nonce").val(),settings:this.$element.find(e.targetWrapper).data("settings")||{},osmIconUrl:eacElementsPath.osmImages+"osm-icons/",osmMarkerShadow:eacElementsPath.osmImages+"marker-shadow.png",proxyPhp:eacElementsPath.proxies+"proxy-osm.php",osmTilesFile:eacElementsPath.osmConfig+"osmTiles.json",osmMap:null,mapData:{title:this.$element.find(e.targetMarkerCenter).find(".osm-map_marker-title")[0].innerText,content:this.$element.find(e.targetMarkerCenter).find(".osm-map_marker-content")[0].innerHTML,lat:this.$element.find(e.targetMarkerCenter).data("lat"),lng:this.$element.find(e.targetMarkerCenter).data("lng")},fullscreenOptions:{position:this.$element.find(e.targetWrapper).data("settings").data_zoompos?"bottomleft":"topleft",title:"Show me the fullscreen",titleCancel:"Exit fullscreen mode",content:null,forceSeparateButton:!1,forcePseudoFullscreen:!0,fullscreenElement:!1}}}onInit(){super.onInit();const e=this;0!==Object.keys(this.elements.settings).length&&fetch(this.elements.proxyPhp+"/?url="+encodeURIComponent(this.elements.osmTilesFile)+"&id="+this.elements.settings.data_id+"&nonce="+this.elements.targetNonce).then((e=>e.json())).then((t=>{Object.keys(t).length>0&&(this.elements.osmMap=this.displayOsmMap(t),window.setTimeout(e.setAccessibilityElements.bind(e),2e3))})).catch((e=>{}))}bindEvents(){this.elements.$targetInstance.on("keydown",(e=>{"Escape"===(e.code||e.key||0)&&this.elements.$targetInstance.next(".eac-skip-grid").trigger("focus")}));this.elements.$targetWrapper.on("keydown",".leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-zoom-fullscreen, .leaflet-control-layers-toggle",(e=>{"Space"===(e.code||e.key||0)&&(e.preventDefault(),e.currentTarget.dispatchEvent(new MouseEvent("click",{cancelable:!0})))}))}displayOsmMap(e){let t={},n={},s=[];jQuery.each(e,((e,s)=>{if(s.url&&s.url.length>0&&s.options&&Object.keys(s.options).length>0){const a=L.tileLayer(s.url,s.options),r=s.options.title?s.options.title:e;"tile"===(s.options.type?s.options.type:"tile")?t[r]=a:n[r]=a}}));const a=L.map(this.elements.settings.data_id,{center:[this.elements.mapData.lat,this.elements.mapData.lng],layers:t[this.elements.settings.data_layer],closePopupOnClick:this.elements.settings.data_clickpopup,zoom:this.elements.settings.data_zoom,zoomControl:!this.elements.settings.data_zoompos,tap:!1}),r=(L.control.layers(t,n,{collapsed:this.elements.settings.data_collapse_menu}).addTo(a),new L.icon({iconUrl:this.elements.osmIconUrl+"default.png",iconSize:[45,45],iconAnchor:[22.5,45],popupAnchor:[0,-45],shadowUrl:this.elements.osmMarkerShadow,shadowSize:[41,41],shadowAnchor:[17,41]})),o="<div class='osm-map_popup-title'>"+this.elements.mapData.title+"</div><div class='osm-map_popup-content'>"+this.elements.mapData.content+"</div>",i=L.marker([this.elements.mapData.lat,this.elements.mapData.lng],{icon:r}).addTo(a).bindPopup(o).on("keydown",(e=>{"Space"===(e.originalEvent.code||e.originalEvent.key||0)&&(e.originalEvent.preventDefault(),jQuery(document.activeElement).trigger("click"))}));if(this.elements.settings.data_openpopup&&i.openPopup(),s.push(L.marker(new L.LatLng(this.elements.mapData.lat,this.elements.mapData.lng))),this.elements.settings.data_import){if(""!==this.elements.settings.data_import_url){const e=this.elements.settings.data_import_sizes.split(",").map(Number),t=[e[0]/2,e[1]],n=[0,-e[1]],s=new L.icon({iconUrl:this.elements.osmIconUrl+this.elements.settings.data_import_icon,iconSize:e,iconAnchor:t,popupAnchor:n,shadowUrl:this.elements.osmMarkerShadow,shadowSize:[41,41],shadowAnchor:[17,41]});jQuery.ajax({url:this.elements.proxyPhp,type:"GET",data:{url:encodeURIComponent(this.elements.settings.data_import_url),id:this.elements.settings.data_id,nonce:this.elements.targetNonce}}).done(((e,t,n)=>{if(e.type&&"FeatureCollection"===e.type){const t=this.elements.settings.data_keywords.includes(",")?this.elements.settings.data_keywords.split(","):[],n=L.geoJSON(e,{pointToLayer:(e,t)=>new L.Marker(t,{icon:s}),onEachFeature:(e,n)=>{if(t.length>0){let s="";jQuery.each(t,((t,n)=>{const a=(n=n.split("|"))[0],r=2===n.length?n[1]:n[0];if(e.properties[a])try{const t=new URL(e.properties[a]);s+="<a href='"+t+"'>"+r+"</a><br/>"}catch{s+="<div class='osm-map_popup-content'><span class='osm-map_popup-label'>"+r+":</span><span class='osm-map_popup-value'> "+e.properties[a]+"</span></div>"}})),n.bindPopup(s).on("keydown",(e=>{"Space"===(e.originalEvent.code||e.originalEvent.key||0)&&(e.originalEvent.preventDefault(),jQuery(document.activeElement).trigger("click"))}))}}}),r=L.markerClusterGroup().addLayer(n);a.addLayer(r).fitBounds(r.getBounds())}else alert(JSON.stringify(e))})).fail(((e,t,n)=>{alert(n)}))}}else if(jQuery.each(this.elements.$targetMarkers,((e,t)=>{const n=jQuery(t).data("lat"),r=jQuery(t).data("lng"),o=jQuery(t).data("icon"),i=jQuery(t).find(".osm-map_marker-title")[0].innerText,l=jQuery(t).find(".osm-map_marker-content")[0].innerHTML,p=jQuery(t).data("sizes").split(",").map(Number),m=[p[0]/2,p[1]],c=[0,-p[1]],d=new L.icon({iconUrl:this.elements.osmIconUrl+o,iconSize:p,iconAnchor:m,popupAnchor:c,shadowUrl:this.elements.osmMarkerShadow,shadowSize:[41,41],shadowAnchor:[17,41]});L.marker([n,r],{icon:d}).addTo(a).bindPopup("<div class='osm-map_popup-title'>"+i+"</div><div class='osm-map_popup-content'>"+l+"</div>").on("keydown",(e=>{"Space"===(e.originalEvent.code||e.originalEvent.key||0)&&(e.originalEvent.preventDefault(),jQuery(document.activeElement).trigger("click"))})),s.push(L.marker(new L.LatLng(n,r)))})),s.length>0&&this.elements.settings.data_zoomauto){const e=L.featureGroup(s);a.fitBounds(e.getBounds(),{padding:[50,50]})}return this.elements.settings.data_zoompos&&L.control.zoom({position:"bottomleft"}).addTo(a),this.elements.settings.data_fullscreen&&L.control.fullscreen(this.elements.fullscreenOptions).addTo(a),!1===this.elements.settings.data_wheelzoom&&a.scrollWheelZoom.disable(),!1===this.elements.settings.data_dblclick&&a.doubleClickZoom.disable(),!1===this.elements.settings.data_draggable&&a.dragging.disable(),a}setAccessibilityElements(){jQuery(".leaflet-control-layers-base",this.elements.$targetWrapper).prepend("<div class='osm-map_layers-title'>Tiles Layer</div>"),jQuery(".leaflet-control-layers-overlays",this.elements.$targetWrapper).prepend("<div class='osm-map_layers-title'>Overlays</div>"),jQuery(".leaflet-tile-container",this.elements.$targetWrapper).attr({role:"img","aria-label":"Tiles layer"}),jQuery(".leaflet-tile-container img",this.elements.$targetWrapper).attr({role:"presentation",alt:""}),jQuery(".leaflet-marker-icon.marker-cluster",this.elements.$targetWrapper).attr("aria-label","Marker cluster"),jQuery(".leaflet-control-layers-toggle",this.elements.$targetWrapper).attr("aria-label","Open/Close selection of tiles and overlays"),this.elements.osmMap.eachLayer((e=>{if(e instanceof L.Marker){const t=e.getPopup();if(t){const n=t.getContent();if(n&&2===jQuery(n).length){const t=jQuery(n).eq(0).text().length>0?jQuery(n).eq(0).text():"Marker";jQuery(e._icon).attr("aria-label","Marker "+t),jQuery(e._icon).attr("alt","Marker "+t)}else jQuery(e._icon).attr("aria-label","Marker")}}}))}}window.addEventListener("DOMContentLoaded",(()=>{window.addEventListener("elementor/frontend/init",(()=>{elementorFrontend.elementsHandler.attachHandler("eac-addon-open-streetmap",widgetOpenStreetMap)}))}));